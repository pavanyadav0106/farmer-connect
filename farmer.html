<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Farmer Dashboard</title>
  <style>
    body {
      background-color: #f0f2f5;
      margin: 0;
      font-family: Arial, sans-serif;
      display: flex;
      padding: 20px;
      gap: 20px;
    }
    .sidebar {
      flex: 1;
      max-width: 300px;
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      height: 80vh;
      overflow-y: auto;
    }
    .sidebar h3 {
      text-align: center;
      color: #333;
    }
    .crop-card {
      background: #fff;
      padding: 10px;
      margin-bottom: 10px;
      border-radius: 5px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      text-align: center;
    }
    .crop-card img {
      width: 100%;
      height: 100px;
      object-fit: cover;
      border-radius: 5px;
    }
    .main-content {
      flex: 1;
      max-width: 400px;
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }
    .main-content input, .main-content button {
      width: 100%;
      padding: 10px;
      margin: 10px 0;
      border: 1px solid #ccc;
      border-radius: 5px;
      box-sizing: border-box;
    }
    .main-content button {
      background-color: #28a745;
      color: white;
      border: none;
      cursor: pointer;
      font-weight: bold;
    }
    .main-content button:disabled {
      background-color: #ccc;
      cursor: not-allowed;
    }
    .loading {
      text-align: center;
      margin-top: 10px;
      display: none; /* Hide by default */
    }
  </style>
</head>
<body>
  <div class="sidebar">
    <h3>My Crops</h3>
    <div id="myCrops"></div>
  </div>
  
  <div class="main-content">
    <h2>Farmer Dashboard</h2>
    <!-- Button to show Add Product Form -->
    <button id="showAddProductBtn">Add New Crop</button>
    
    <!-- Add Product Form (Initially hidden) -->
    <div id="addProductForm" style="display: none;">
      <input type="text" id="productName" placeholder="Product Name" />
      <input type="number" id="productPrice" placeholder="Price (₹)" min="0" />
      <input type="number" id="productQuantity" placeholder="Quantity (kg)" min="0" />
      <input type="file" id="productImage" accept="image/*" />
      <button id="addProductBtn">Add Product</button>
      <div class="loading" id="loadingSpinner">Uploading... <span id="uploadProgress">0%</span></div>
    </div>
  </div>

  <script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getFirestore, collection, addDoc, serverTimestamp, query, where, orderBy, onSnapshot , getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";


    const firebaseConfig = {
      apiKey: "AIzaSyDPrPDAj7o58AijhzBpytGKcsuxHYCGhaY",
      authDomain: "farmer-connect-8d0ea.firebaseapp.com",
      projectId: "farmer-connect-8d0ea",
      storageBucket: "farmer-connect-8d0ea.appspot.com",
      messagingSenderId: "164327825853",
      appId: "1:164327825853:web:00c05f326aab3c4683b2d4",
      measurementId: "G-B5HJ84QDL6"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    // Toggle Add Product Form visibility
    document.getElementById('showAddProductBtn').addEventListener('click', () => {
      const form = document.getElementById('addProductForm');
      const isFormVisible = form.style.display === 'block';
      form.style.display = isFormVisible ? 'none' : 'block';
    });

    // Load Farmer's Crops
    function loadFarmerCrops(farmerId) {
  console.log("Fetching crops for farmerId:", farmerId);
  const q = query(collection(db, 'products'), where('farmerId', '==', farmerId));
  onSnapshot(q, (snapshot) => {
    console.log("Snapshot size:", snapshot.size);
    const cropsContainer = document.getElementById('myCrops');
    cropsContainer.innerHTML = '';
    snapshot.forEach(doc => {
      console.log("Fetched Crop:", doc.data());
      const crop = doc.data();
      cropsContainer.innerHTML += `
        <div class="crop-card">
          <img src="${crop.imageUrl}" alt="${crop.name}" />
          <h4>${crop.name}</h4>
          <p>Price: ₹${crop.price}</p>
          <p>Quantity: ${crop.quantity} kg</p>
        </div>
      `;
    });
  });
}


    // Authentication State Check
    onAuthStateChanged(auth, (user) => {
      if (!user) {
        alert('You are not logged in!');
        window.location.href = 'index.html';
      } else {
        console.log("Logged in as:", user.uid); // Debugging
        loadFarmerCrops(user.uid);      }
    });

    // Add New Product
    document.getElementById('addProductBtn').addEventListener('click', async () => {
    const name = document.getElementById('productName').value.trim();
    const price = parseFloat(document.getElementById('productPrice').value.trim());
    const quantity = parseFloat(document.getElementById('productQuantity').value.trim());
    const imageFile = document.getElementById('productImage').files[0];

    if (!name || isNaN(price) || price <= 0 || isNaN(quantity) || quantity <= 0 || !imageFile) {
        alert('⚠️ Please enter valid product details and select an image!');
        return;
    }

    document.getElementById('loadingSpinner').style.display = 'block';
    document.getElementById('addProductBtn').disabled = true;

    try {
        const formData = new FormData();
        formData.append("image", imageFile);
        const response = await fetch(`https://api.imgbb.com/1/upload?key=6cdffb0a5bf8715e4a192229ad9c901e`, {
            method: "POST",
            body: formData
        });
        const result = await response.json();
        console.log("Image upload response:", result);
        if (!result.success) throw new Error("Image upload failed");
        const imageUrl = result.data.url;
        document.getElementById('uploadProgress').innerText = '100%';

        const user = auth.currentUser;
        if (user) {
            await addDoc(collection(db, 'products'), {
                name,
                price,
                quantity,
                imageUrl,
                status: 'available',
                createdAt: serverTimestamp(),
                farmerId: user.uid
            });

            alert('✅ Product uploaded successfully!');

            // Clear input fields
            document.getElementById('productName').value = '';
            document.getElementById('productPrice').value = '';
            document.getElementById('productQuantity').value = '';
            document.getElementById('productImage').value = '';

            document.getElementById('loadingSpinner').style.display = 'none';
            document.getElementById('addProductBtn').disabled = false;
            document.getElementById('addProductForm').style.display = 'none';

            // Refresh crops after adding
            loadFarmerCrops(user.uid);
        }
    } catch (error) {
        console.error('❌ Error adding product:', error);
    }
});


  </script>
</body>
</html>
